---
title: 《TCP/IP详解》协议卷读书笔记之 概述
date: 2020-08-07 14:00:00
categories: 网络
index_img: /img/articles/tcp_ip1.jpg
tags:
	- 网络
	- TCP
	- IP
---

本文是经典著作《TCP/IP详解》协议卷（卷一）的读书笔记，对第一章概述部分进行总结与梳理。

<!-- more -->

人与人之间是通过某种语言来沟通的，可以将使用的语言看成是人与人之间的沟通协议，不同的语言可以看作是不同的协议。如果两个人之间使用不同的语言（即使用的协议不同），就无法交流了。同样，计算机之间如果需要沟通，也需要某种“语言”，并且这样的“语言”对于参与沟通的计算机而言是可以被理解的。这样的计算机语言也就是协议。

在计算机世界里，协议是非常重要的。一系列相关的协议可以被总称为协议簇（`protocol suite`）。一般将TCP/IP看成是一个协议簇，而不是指单独的TCP协议或者IP协议，TCP/IP协议还包含相关的其他很多协议。

## 协议架构理论

TCP/IP协议簇的目的，是使得世界上各种设备制造商生产的各种类型的电子设备（笔记本、智能手机、嵌入式通信设备等）能够互相通信。TCP/IP协议簇是一个开放的系统（`open system`），使用基本上是免费的。

在Internet架构发展早期，确定了一些架构发展的目标：

- 就算系统中某些网络或者路由损坏，Internet需依然能够正常通信；
- Internet需支持多种类型的通信方式；
- Internet架构需兼容多种类型的网络；
- Internet架构能够管理网络上的分布式资源；
- Internet架构实施起来不能太费钱，要经济实惠；
- Internet架构需比较容易地允许一台主机的接入；
- 在Internet架构上使用的资源情况需要被完整的统计。

### 端到端原则

在Internet架构设计中，存在一个特定的功能或者特性应该位于架构的什么位置的问题。对于此问题，形成了一种设计原则，即端到端原则（`end-to-end argument`）。

端到端原则认为，只有涉及通信系统的应用程序与最终用户，网络的正确性与完整性才能实现。即，**如果一种机制能够在端系统中实现，那么其就不应该在网络核心中实现，网络核心应该尽可能地提供通用的服务，而具体应用相关的功能应该避免在网络核心中实现**。

端到端原则，目的是让端系统承担网络应用的开发与创新，而尽可能地让网络核心保持相对的简单（尽管如此，现在的网络核心已经非常的复杂了）。原则认为重要的功能（如差错控制，加密等）不应该在系统的底层实现，而底层应该提供方便端系统工作的功能，并尽可能地改善性能。因此底层的实现不应该以完美为目标，底层允许出错，上层应用需能够处理底层出错的情况。

因此，端到端原则，倾向于使用一个“傻瓜”式的网络，以及连接到网络的“智能”系统的设计方案。

### 命运共享原则

命令共享原则（`fate sharing`），就是将所有维护一个活动的通信链接所必须的状态信息存放在端系统，通过端系统的状态信息的交换，来维持通信的链接。

对应的，维持通信的链接，不应该通过检测整个通信链路中的各个中间实体（路由器，交换机，通信线路等）是否有效来实现。

如果在中间实体中维护有个通信的状态数据，则会面临状态的多副本一致性问题，且若中间实体失效，会影响通信的能力。

### 错误控制与流量控制

通常在网络传输过程中，一定会有错误发生。对于错误的检测与处理，被称为错误控制（`error control`）。一般而言错误控制这个功能，可以由网络核心完成，也可以有端设备完成，或者由路由设备来实现。

但是，对于一些少量的位数据错误的error，可以通过一些算法来检测与纠正，这样简单的错误控制可以由网络核心来完成，比如使用CRC校验机制等。

当一些数据包存在大量的错误，或者数据损坏时，一般的处理方式只是简单的丢弃该数据包，重新发送而已。这样的错误控制机制通常是在TCP协议中实现。如果努力保证所有的传输的数据包准确无误，按序交付，则实际花费的代价会很大，最终对于结果而言，可能是得不偿失的。因此，Internet架构设计时，采用的是尽力而为的交付（`best-effort delivery`）。

对于尽力而为的交付，网络不保证数据传输没有任何错误，只是尽力保证数据传输的准确，而对于某些需要数据传输的准确性与有序性的应用而言，对数据可靠性的实现，是应用自身的事情，应用自己需考虑一些机制来保证数据的可靠性。

当一个数据的发送者，其发送信息的速率大于数据接受者的速率，则在数据接收者处，会产生溢出，需要一种流量控制机制（`flow control`）来解决该问题。一般是TCP协议来实现流量控制。

## 实现

协议架构只是提供了一个实现的理论方法，但是具体将协议通过软件、硬件的方式实现出来，是另外一回事了。因此，对应着协议架构（`protocol architecture`），还有实现架构（`implementation architecture`）。

在网络协议的落地过程中，早期的大神们使用了一种被称为层（`layers`）的软件设计方式，来实现协议簇

### 层

基于层的网络设计中，将网络功能划分为不同的层，每一层只负责网络通信的一部分功能。层设计使得可以将较为复杂的网络系统划分为不同独立部分，不同领域的专家负责不同的层设计。

ISO（`international organization for standardization`）定义了一种较为流行的网络模型，被称为OSI（`open systems interconnection`），OSI网络模型有7层，但是Internet网络模型有5层，相比OSI网络模型较为简化。

OSI网络模型结构图见下图所示：

![](figure1_2.png)

各层的具体功能划分为：

- 物理层（`physical`）：定义了在不同的通信传输介质中传递数字信号的方法与标准，比如以太标准，WiFi标准等
- 链路层（`link`）：定义了与使用同一传输介质的邻居节点建立链接的协议与方法
- 网络层（`network`）：定义了数据包格式、地址分配方式，路由算法等
- 传输层（`transport`）：提供了一个会话之间的数据流
- 会话层（`sessions`）：表示应用程序之间的交互，包括连接初始化，连接重置，cookies等
- 表示层（`presentation`）：定义了消息数据的编码格式
- 应用层（`application`）：特定应用服务的协议，有很多的应用协议，应用层的协议是网络协议中数量最多，创新也最多的协议类型。

### 复用、解复用与封装

Internet架构是分层设计的，因此其天然支持复用（`multiplexing`）、解复用（`demultiplexing`）与封装（`encapsulation`）。

在Internet架构中，按照OSI模型，被分为5层，分别为最底层的物理层，再往上依次为链路层、网络层、传输层、最上层是应用层。可以理解下层协议上上层协议的载体，即上层协议的数据被封装后，交由下层协议来传输。

例如，对于链路层，接收网络层的数据包，将其封装，添加链路层的头部数据或者尾部数据后，在链路层传输。链路层并不关心网络层数据的具体内容，只是将其透明传输。接收端的链路层接收到数据后，将其剥离头部与尾部后，上传至接收端的网络层，由网络层解释数据包的含义。

对于链路层，一帧数据可以包含多种类型的网络层协议数据包，这样就是复用。在解帧数据时，可通过每个帧数据的头部标识，识别网络层数据是哪种类型的网络层协议数据，并将其交由对应的协议处理。

封装的示意图如下所示：

![](figure1_3.png)

网络架构的设计目标，就是下层协议对上层协议隐藏细节，因此，最上层的应用层协议，是看不到下层具体网络传输的细节，因此应用层可专注于应用逻辑的实现，而不必关心网络的传输具体情况。这样的抽象能力也是Internet的强大之处。

## TCP/IP协议簇的架构与协议

### ARPANET参考模型

ARPANET参考模型是被TCP/IP协议簇所采用的网络模型。ARPANET参考模型相比OSI模型比较简单一些，但是包含一些非常规的层，这些非常规的层，使用了诸如2.5、3.5之类的数字来表示其位于2层与3层之间，或者3层与4层之间。

ARPANET参考模型示意图见下图所示：

![](figure1_5.png)

- 2.5层：非正式层，在该层，最重要的协议是ARP（`address resolution protocol`）。该协议被IPv4使用，用于IP地址与MAC地址的转换。而对于IPv6，地址映射相关的协议为ICMPv6
- 3层：该层主要是IP协议，包括IPv4与IPv6，在IP协议中，存在分片（`fragments`）与重组（`reassembly`）的概念，还存在IP地址的单播（`unicast`）、广播（`broadcast`）、组播（`multicast`）的概念
- 3.5层：该层主要为ICMP（`internet control message protocol`）与IGMP（`internet group management protocol`）。ICMP是IP的一个辅助协议，IP使用其与其他的主机或者路由器的IP层之间交换差错消息与其他重要信息，存在两个版本：ICMPv4与ICMPv6。另外ICMP也可以被应用层使用，比如ping命令。IGMP是IPv4的辅助协议，用于组播时管理组中的主机成员
- 4层：即传输层，主要的协议为TCP（`transmission control protocol`）与UDP（`user datagram protocol`）。TCP协议处理数据包的丢失，重复，乱序等问题，提供了可靠性数据流服务，而UDP没有速率控制与差错控制，但是性能相比TCP较高，可靠性较低。另外还有两个不常使用的传输层协议，分别为DCCP（`datagram congestion control protocol`）与SCTP（`stream control transmission protocol`）
- 7层：即应用层，具有最多应用协议的层。

### 端口号

端口号是一个16位的非负整数，范围是0~65535。端口号不映射任何物理设备，是虚拟的，用来确定对应的应用。端口号类似于电话号码，只不是是服务端的电话号码，客户端程序可通过IP地址与端口号来找到对应的服务端。

在国际上存在一个机构IANA（`internet assigned numbers authority`）复制分配权威的端口号，端口号被划分为三段：

- `well-known`：包含0~1023
- `registered`：包含1024~49151
- `dynamic or private`：包含49152~65535

一些`well-known`端口号，以及对应的服务包括：

- SSH（`secure shell protocol`），port 22
- FTP，port 20 and port 21
- Telnet，port 23
- SMTP（`simple mail transfer protocol`），port 25
- DNS（`domain name system`），port 53
- HTTP，port 80
- HTTPS，port 443
- IMAP（`interactive mail access protocol`），port 143

### DNS

DNS（`domain name system`）是一个分布式的数据库系统，用来存储主机名（`host name`）与IP地址之间的映射关系。使用主机名便于人类的记忆，而IP地址难以记忆，特别是IPv6的地址，128位的数字长度，对于人类而言并不友好。

DNS是应用层协议，系统提供了标准接口，供主机名与IP地址的互相转换。

## 网络应用

没有网络应用提供的各种服务，Internet也就无用武之地了。网络应用的设计可以遵循一些模型。

### 客户端与服务端

大多数的网络应用，被设计成一端为客户端，另一端为服务端。服务端为客户端提供一些特定的服务。

服务端可以被分为两种类型：迭代（`iterative`）与并发（`concurrent`）。迭代类型的服务端，可以简单理解为服务端为单线程，一次只能服务一个客户端，与前一个客户端通信完成后，才能与下一个客户端进行通信。而并发类型的服务端，就是多线程，服务端可同时与多个客户端进行通信。

显然，并发类型的服务端，具有更好的性能。

客户端通常情况下，是不能识别服务端是迭代类型还是并发类型。

### peer-to-peer

还有一些网络应用被设计为分布式架构，即没有一个单独的服务端，每一个应用节点既可以是客户端，也可以是服务端，或者同时是服务端与客户端。如`BitTorrent`就是p2p类型的网络应用。

一个并发的p2p网络应用，接收到一个服务请求后，先确定自己是否有能力提供服务，若没有则转发该服务请求至别的应用节点。所有的应用节点就可以组成了一个服务集群，应用节点之间互相交互信息，形成一个网络，被称为`overlay network`。

p2p网络应用的主要难点是发现其他应用节点的问题，即一个应用节点如何发现能够提供所需服务或者数据的其他应用节点。

## 标准化

对于网络新手，经常会疑惑，这些复杂的网络协议是谁负责整理、管理与标准化的？实际在国际上，有很多的组织，负责不同的网络协议的标准化工作。

IETF（`internet engineering task force`）负责Internet核心协议的标准化，每年在全球各地开三次会议，讨论制定核心协议的标准化。至于什么协议属于Internet核心协议存在争论，但是如IPv4、IPv6、TCP、UDP、DNS等毫无疑问均属于Internet核心协议。

IETF会选出两个领导小组，一个是IAB（`internet architecture board`），另一个是IESG（`internet engineering steering group`）。IAB负责提供IETF的活动指导与其他任务，如任命标准制定组织的联络员等。而IESG是具有决策权的，可以修改现有的协议标准，审批新的协议标准。

除了IETF，还有两个重要的组织，一个是IRTF（`internet research task force`）负责讨论那些还没有成熟到足以形成标准的协议，体系架构。另一个是ISOC（`internet society`），与IAB一起共同影响与促进世界范围内的有关Internet技术的使用与培训。

### RFC

在Internet社区，每一个正式标准都会被出版为一个RFC（`request for comments`）。在成为RFC之前，协议文件是以`internet drafts`的形式存在，以接收审查与讨论。

并不是所有的RFC都是标准，只有分类为`standards-track`的RFC才是官方标准，RFC还有其他的分类，包括`best current practice`、`informational`、`experimental`与`historic`。因此需要意识到，当一个协议文件称为RFC，并不意味着IETF已经将其指定为协议标准了。

可以从网站 https://www.rfc-editor.org/ 查阅到相关的RFC文件。
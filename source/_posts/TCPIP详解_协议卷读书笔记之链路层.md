---
title: 《TCP/IP详解》协议卷读书笔记之 链路层
date: 2020-08-09 9:35:00
categories: 网络
index_img: /img/articles/tcp_ip3.jpg
tags:
	- 网络
	- TCP
	- IP

---

本文是经典著作《TCP/IP详解》协议卷（卷一）的读书笔记，对第三章链路层部分进行总结与梳理。

<!-- more -->

在TCP/IP协议簇中，链路层主要作用是为IP模型发送与接收IP数据报，另外还传输一些IP辅助协议，比如ARP等。TCP/IP协议簇支持很多类型的链路层，根据底层的物理传输介质的不同，可支持以太、MANs、有线电视、电话网络、WiFi等。

一般使用术语`frame`来表示链路层的传输数据块，即PDUs，`frame`的长度是可以变化的，最大的长度为MTU（`maximum transmission unit`）。

## 以太与IEEE 802标准

术语`ethernet`指的是由Intel等公司发布的一系列标准。在早期的以太传输系统是低速的，采用的架构是类型公用总线的方式，总线上链接多个节点，每个时刻只有一个节点可以独占该总线，因此存在分布式算法来协调各个节点使用总线的方式，方法主要包括节点在发送时检测总线上的冲突，并延时发送，或者将划分总线使用时段给每个节点等。

这种使用总线的方式毫无疑问是低效的。示意图如下：

![](figure3_1.png)

随着网络的高速发展，需要以太网络速率提升以满足网络发展的需要。以太网络的架构发生了变化，网络节点之间不再是共享传输总线的方式，而是使用交换机连接各个节点，通过交换机，使得各个节点可同时通信。

![](figure3_2.png)

### IEEE 802标准

在早期，以太网络还没有形成标准，只是在一些企业之间形成共识，包括以太帧的格式。

随后IEEE组织将其制定为标准，即IEEE 802 LAN and MAN标准。这些标准都以数字802作为前缀。

![](table3_1_1.png)

![](table3_1_2.png)

### 以太帧格式

所有的802.3以太帧都基于一个共同的帧格式，如下图所示：

![](figure3_3.png)

以下对帧格式的各个域进行解释：

- `Preamble`：用来给接收端的端口确定一个以太帧的开始，并且确定该以太帧的各个数据位之间的编码时间（`clock recovery`）。因为以太帧是异步通信，在不同的端口之间，其数据位的保持时间可能会不同，因此7字节的preamble域一般为0xAA，即1与0间隔出现，以方便测试确定数据位的时钟间隙
- `SFD`：当发现SFD，表示数据位的时间间隙测试结束，随后即是数据帧内容，一般1字节的SFD固定为0xAB
- `DST`：目的端的MAC地址，也允许为广播或者组播MAC地址
- `SRC`：源端的MAC地址
- `Length or Type`：表示类型域，也表示长度域，如0x0800表示传输数据协议为IPv4，0x86DD表示传输数据协议为IPv6，0x0806表示传输数据协议为ARP，0x8100表示传输的是一个Q-tagged帧
- `P/Q tag`：VLAN相关传输的标签位，当不同的VLAN内的主机通过同一个交换机时，标签用来识别该帧是属于哪一个VLAN
- `payload`：即IP层的数据块，一般限制为1500字节
- `pad`：填充位，一般填充0x00，以保证帧长度满足最小长度的要求，对于常规的帧格式，最小长度为64字节，最大长度为1518字节（包括4字节校验位与14字节头部）
- `FCS`：即帧数据的校验位，即`frame check sequence`。一般会使用CRC校验（`cyclic redundancy check`）

## 网桥与交换机

交换机，就是高性能的网桥，用来连接多个物理链路网络。比如，使用两个交换机来组建一个局域网：

![](figure3_8.png)

对于每个交换机，除了知道自身的MAC地址与端口以外，还需要知道其他主机或者交换机的MAC地址与端口，这样交换机才能知道如何转发帧数据。其他主机或者交换机的MAC地址与端口信息是通过“学习”获取的。学习获取的MAC地址与端口信息存储在交换机的数据库中，对于上图，类似的数据库存储信息为：

![](figure3_9.png)

举个例子，说明下交换机的自学习过程：

假设某个以太交换机，具有4个端口，分别为端口1、端口2、端口3与端口4。每个端口都连接一台主机，四个主机的MAC地址分别为A、B、C与D。在交换机刚启动时，其交换表为空。

假如MAC地址为A的主机向MAC地址为B的主机发送一帧数据，从端口1进入交换机。交换机收到该帧数据后，首先查询其交换表，不过显然此时交换表为空，交换机不知道应该从哪个端口转发该帧数据，但是交换机根据该帧数据可以学习到，从端口1一定是可以接收到MAC地址为A的主机是数据。因此，若以后有数据需转发给MAC地址A，则从端口1转发数据一定没有错。所以，交换机将MAC地址A与端口1作为一个条目，写入交换表中。

随后，交换机会将该帧数据向除了端口1以外的其他端口进行广播发送。MAC地址为C的主机与MAC地址为D的主机收到该帧数据后，发现目的MAC地址与其不符合，直接丢弃该帧数据，只有MAC地址为B的主机会接收该帧数据。

经过一段时间后，交换机会将所有发送过数据的主机的MAC地址与对应的端口号记录到交换表中，这样逐渐地，交换表就齐全了，后续转发帧数据，就不再需要广播，直接根据交换表信息，转发数据至对应的端口即可。

### STP

STP（`spanning tree protocol`）是一种协议，以防止在交换机之间形成死循环的交换路径。假设如下的情况：

![](figure3_12.png)

主机S发送一帧数据，通过端口6进入交换机B。由于初始阶段，交换机B的交换表为空，因此交换机B将该帧数据广播出去，即通过端口7发送给交换机A、通过端口8发送给交换机D、通过端口9发送给交换机C。

而交换机A、C、D也同样在初始阶段的交换表为空，因此他们也各自将该帧数据广播转发。这样交换机A通过端口2与3转发数据给交换机C与D、交换机C通过端口13与14转发数据给交换机A与D、交换机D通过端口22与20转发数据给交换机A与C。此时，各个交换机是懵逼了，这一帧数据不知道是应该通过哪个端口发出去了，而且各个交换机记录的交换条目将出现混淆。

此时，就需要STP协议，其通过禁止某个端口的工作，在网络中形成`spanning tree`，以避免网络拓扑结构出现循环的情况。这样对于任意两个节点，就只有一条传输路径。

![](figure3_13.png)

对于STP协议，需要能够处理很多情况，比如交换机被关闭再打开，端口芯片被替换，MAC地址被更改等，这些操作都会影响spanning tree。STP协议适应这些变化的方法，就是使用BPDUs（`bridge protocol data units`）帧数据进行交换信息，这些信息用于维持网络中的spanning tree的稳定。

为了理解STP，首先需要了解交换机中每个端口的状态机：

![](figure3_14.png)

在交换机中的每个端口可能处于5种状态之一：`blocking`、`listening`、`learning`、`forwarding`、`disabled`。

在初始化后，端口进入`blocking`状态，此时端口不学习地址，不转发帧数据，也不发送BPDUs帧，但是端口检查接收到的BPDUs帧数据，若发现端口自身被加入spanning tree路径中，端口就转入`listening`状态。

在`listening`状态的端口，可以接收与发送BPDUs帧数据，但是不学习地址，也不转发其他帧数据。经过15s的延时后，端口就转入`learning`状态。

在`learning`状态的端口，除了不能转发常规数据帧以外，可以执行其他任何操作。经过15s的延时后，端口就转入`forwarding`状态。

在`forwarding`状态的端口，就是正常工作状态的端口，可以转发常规数据帧了。

根据端口的状态机，每个端口都有角色（`role`）。端口的角色可以有`root port`、`designated port`、`alternate port`、`backup port`。

`root port`是spanning tree的根端口。

`designated port`是处于`forwarding`状态的，到根端口的路径成本最小的端口

`alternate port`是到根端口的路径成本高一些的端口，这些端口不处于`forwarding`状态

`backup port`是备份端口，是可以随时替换`designated port`的端口

BPDU帧格式如下，具体字段的含义不再赘述，读者可查阅相关资料：

![](figure3_15.png)

对于STP首要的任务是选择根交换机，选择根交换机的过程，也是一个选举算法。约定选择网络中ID为最小的交换机为根交换机，这里的ID一般为MAC地址。当一个交换机初始化时，其假设自己为根交换机，将自己的ID地址填入BPDUs帧，并广播出去，但是若其接受到其他交换机发送的BPDUs帧中包含的ID为更小的值，则该交换机将承认这个ID更小的交换机为根交换机。







